<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Parking â€” Single Slot</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1224; --muted:#9aa4b2;
    --free:#16a34a; --booked:#f59e0b; --occ:#dc2626;
  }
  body{
    background:var(--bg); color:white; font-family:Segoe UI, sans-serif;
    display:flex; justify-content:center; padding:20px;
  }
  .card{
    background:var(--card); padding:20px; border-radius:12px; width:350px;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
  }
  h2{text-align:center;}
  .status{
    padding:10px; border-radius:8px; margin:10px 0; text-align:center;
    font-weight:bold; font-size:1.2em;
  }
  .input-group{margin:10px 0;}
  label{display:block; font-size:0.9em; color:var(--muted);}
  input, button{
    width:100%; padding:8px; border-radius:6px; border:none; margin-top:5px;
  }
  button{
    background:#2563eb; color:white; font-weight:bold; cursor:pointer;
  }
  button:hover{background:#1d4ed8;}
</style>
</head>
<body>
<div class="card">
  <h2>Slot S1</h2>
  <div id="slotStatus" class="status">Loading...</div>
  <form id="bookingForm">
    <div class="input-group">
      <label>Name</label>
      <input type="text" id="name" required>
    </div>
    <div class="input-group">
      <label>Arrival Time (HH:MM)</label>
      <input type="time" id="arrival" required>
    </div>
    <div class="input-group">
      <label>Leave Time (HH:MM)</label>
      <input type="time" id="leave" required>
    </div>
    <button type="submit">Book Slot</button>
  </form>
  <button id="cancelBtn" style="margin-top:10px;background:#dc2626;">Cancel Booking</button>
</div>

<script>
const firebaseURL = "https://smartparkingsystem-55a05-default-rtdb.firebaseio.com/S1.json";

// Helper: convert HH:MM to minutes
function toMinutes(hhmm){
  if(!hhmm || hhmm.length<5) return null;
  const h = parseInt(hhmm.substring(0,2));
  const m = parseInt(hhmm.substring(3,5));
  return h*60 + m;
}

// Load slot status
async function loadStatus(){
  const res = await fetch(firebaseURL);
  const data = await res.json();
  const statusDiv = document.getElementById("slotStatus");

  if(!data){ 
    statusDiv.style.background = "gray";
    statusDiv.textContent = "Unknown";
    return;
  }

  let state = data.state;
  const now = new Date();
  const nowHM = now.getHours().toString().padStart(2,"0") + ":" + now.getMinutes().toString().padStart(2,"0");
  const nowMin = toMinutes(nowHM);
  const arrMin = toMinutes(data.arrivalTime || "");
  const leaveMin = toMinutes(data.leaveTime || "");

  // --- Booking logic for display ---
  if(state === "booked" && arrMin){
    // reserved window: arrival-15 up to arrival
    if(nowMin >= (arrMin-15) && nowMin < arrMin){
      state = "reserved";
    } 
    // booking expired if late >1 min
    else if(nowMin > arrMin+1){
      state = "free";
    }
  }
  if(state === "occupied" && leaveMin && nowMin >= leaveMin){
    state = "free"; // free after leaveTime
  }

  // --- Display ---
  if(state === "free"){
    statusDiv.style.background = "var(--free)";
    statusDiv.textContent = "FREE";
  }
  else if(state === "booked"){
    statusDiv.style.background = "var(--booked)";
    statusDiv.textContent = "BOOKED - " + (data.name || "");
  }
  else if(state === "reserved"){
    statusDiv.style.background = "var(--booked)";
    statusDiv.textContent = "RESERVED - " + (data.name || "");
  }
  else if(state === "occupied"){
    statusDiv.style.background = "var(--occ)";
    statusDiv.textContent = "OCCUPIED - " + (data.name || "");
  }
}

// Booking submit
document.getElementById("bookingForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("name").value;
  const arrival = document.getElementById("arrival").value;
  const leave = document.getElementById("leave").value;
  const payload = {
    state:"booked",
    name:name,
    arrivalTime:arrival,
    leaveTime:leave
  };
  await fetch(firebaseURL, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  loadStatus();
});

// Cancel booking
document.getElementById("cancelBtn").addEventListener("click", async ()=>{
  const payload = {state:"free", name:"", arrivalTime:"", leaveTime:""};
  await fetch(firebaseURL, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  loadStatus();
});

setInterval(loadStatus, 2000);
loadStatus();
</script>
</body>
</html>

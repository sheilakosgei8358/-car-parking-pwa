<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart Parking System</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:#0b1022;color:#e5e7eb}
  header{background:#0b1022;border-bottom:1px solid #334155;padding:12px 16px}
  header h1{margin:0;font-size:18px}
  header .sub{font-size:12px;color:#9aa4b2}
  .container{max-width:400px;margin:16px auto;padding:0 16px}
  .card{background:#0b1224;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .status{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .free{background:#16a34a;color:#052e16}
  .booked{background:#f59e0b;color:#291400}
  .occupied{background:#ef4444;color:#2a0b0b}
  label{font-size:12px;font-weight:600;color:#e5e7eb}
  input{width:100%;padding:6px 8px;border-radius:6px;margin-top:4px;border:1px solid #94a3b8;color:#0b1224}
  .btn{all:unset;background:#1f2937;border:1px solid #334155;padding:8px 12px;border-radius:8px;margin-top:8px;display:block;text-align:center;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:#9aa4b2;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>ðŸš— Smart Parking â€” Slot S1</h1>
  <div class="sub" id="note">Ready.</div>
</header>
<div class="container">
  <div id="slotCard"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
<script>
// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyC83XNFywh1cxT-0ty6pM9d_mIevHUzI74",
  authDomain: "smartparkingsystem-55a05.firebaseapp.com",
  databaseURL: "https://smartparkingsystem-55a05-default-rtdb.firebaseio.com",
  projectId: "smartparkingsystem-55a05",
  storageBucket: "smartparkingsystem-55a05.firebasestorage.app",
  messagingSenderId: "200855735860",
  appId: "1:200855735860:web:369dd1116fc4ab21148461",
  measurementId: "G-XHXNGLQBFH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const $ = id => document.getElementById(id);
let timerInt = null;

// ===== Render Slot =====
function render(slot){
  clearInterval(timerInt);
  const now = Date.now();
  let status = slot.status || "free";
  let booked = slot.booking || null;

  const card = document.createElement("div");
  card.className = `card`;
  let statusClass = status;
  let statusLabel = status.toUpperCase();

  let innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <b>S1</b>
      <span class="status ${statusClass}">${statusLabel}</span>
    </div>`;

  if(status === "booked" && booked){
    const arrivalMs = Date.parse(booked.arrivalTime);
    const expiresAt = arrivalMs + 60000; // 1 minute grace
    let remaining = Math.max(0, expiresAt - now);

    innerHTML += `
      <div class="muted">By: <b>${booked.name}</b></div>
      <div class="muted">Arrival: ${booked.arrivalTime}</div>
      <div class="muted">Leaving: ${booked.leavingTime}</div>
      <div class="muted">Expires in: <span id="timer"></span></div>
      <button class="btn" onclick="cancelBooking()">Cancel Booking</button>
    `;

    timerInt = setInterval(()=>{
      remaining -= 1000;
      updateTimer(remaining);
      if(remaining <= 0){
        clearInterval(timerInt);
        db.ref("slots/S1/booking").remove();
        db.ref("slots/S1/status").set("free");
      }
    },1000);
    updateTimer(remaining);

  } else {
    innerHTML += `
      <label>Name</label><input id="name">
      <label>Arrival</label><input id="arrival" type="datetime-local">
      <label>Leaving</label><input id="leaving" type="datetime-local">
      <button class="btn" onclick="bookSlot()">Book Slot</button>
    `;
  }

  innerHTML += `<button class="btn" onclick="toggleOccupied()">${status === "occupied" ? "Mark as Free" : "Mark as Occupied"}</button>`;

  card.innerHTML = innerHTML;
  $("slotCard").innerHTML = "";
  $("slotCard").appendChild(card);
}

function updateTimer(ms){
  const el = $("timer");
  if(el) el.textContent = `(${Math.ceil(ms/1000)}s)`;
}

function toast(msg){
  $("note").textContent = msg;
  setTimeout(()=> $("note").textContent = "Ready.",3000);
}

// ===== Booking / Cancel / Occupancy =====
function bookSlot(){
  const name = $("name").value.trim();
  const arrival = $("arrival").value;
  const leaving = $("leaving").value;
  if(!name || !arrival || !leaving) return toast("Fill all fields!");
  db.ref("slots/S1").transaction(cur=>{
    cur = cur || {};
    if(cur.status === "occupied" || cur.booking) return;
    return {...cur, status:"booked", booking:{name, arrivalTime:arrival, leavingTime:leaving}};
  });
}

function cancelBooking(){
  db.ref("slots/S1/booking").remove();
  db.ref("slots/S1/status").set("free");
}

function toggleOccupied(){
  db.ref("slots/S1").once("value").then(snap=>{
    const val = snap.val() || {};
    db.ref("slots/S1/status").set(val.status === "occupied" ? "free" : "occupied");
  });
}

// ===== Live update from Firebase =====
db.ref("slots/S1").on("value",snap=>{
  render(snap.val() || {status:"free"});
});
</script>
</body>
</html>

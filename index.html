<!DOCTYPE html>
<html>
<head>
  <title>Smart Parking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .slot-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      color: white;
      font-weight: bold;
    }
    .free { background: green; }
    .booked { background: orange; }
    .occupied { background: red; }
    .timer { font-size: 14px; color: #555; margin-top: 5px; }
    input, button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #2196f3;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<h1>Smart Parking Dashboard</h1>
<div class="slot-grid" id="slotGrid"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC83XNFywh1cxT-0ty6pM9d_mIevHUzI74",
    authDomain: "smartparkingsystem-55a05.firebaseapp.com",
    databaseURL: "https://smartparkingsystem-55a05-default-rtdb.firebaseio.com",
    projectId: "smartparkingsystem-55a05",
    storageBucket: "smartparkingsystem-55a05.firebasestorage.app",
    messagingSenderId: "200855735860",
    appId: "1:200855735860:web:369dd1116fc4ab21148461",
    measurementId: "G-XHXNGLQBFH"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const slotGrid = document.getElementById('slotGrid');

  // Fetch slots in real-time
  db.ref("slots").on("value", snapshot => {
    const slots = snapshot.val() || {};
    slotGrid.innerHTML = "";
    Object.keys(slots).forEach(slotId => {
      const slot = slots[slotId];
      const now = Date.now();
      let statusClass = "free";
      let statusText = "Free";
      let timerText = "";

      // Determine status
      if (slot.occupied) {
        statusClass = "occupied";
        statusText = "Occupied";
      } else if (slot.booking) {
        const arrivalTime = new Date(slot.booking.arrival).getTime();
        const expiryTime = arrivalTime + 1*60*1000; // 1 minute grace
        if (now < expiryTime) {
          statusClass = "booked";
          statusText = "Booked";
          const remaining = expiryTime - now;
          const sec = Math.floor(remaining/1000);
          timerText = `Time left: ${sec}s`;
        } else {
          // Auto-cancel expired booking
          db.ref("slots/" + slotId + "/booking").remove();
          statusClass = "free";
          statusText = "Free";
        }
      }

      // Build slot card
      const card = document.createElement("div");
      card.className = "slot-card";
      card.innerHTML = `
        <h3>Slot ${slotId}</h3>
        <span class="status ${statusClass}">${statusText}</span>
        ${timerText ? `<div class="timer">${timerText}</div>` : ""}
        <p>Location: ${slot.location || "N/A"}</p>
        ${slot.booking ? `
          <p><b>Name:</b> ${slot.booking.name}</p>
          <p><b>Arrival:</b> ${slot.booking.arrival}</p>
          <p><b>Leaving:</b> ${slot.booking.leaving}</p>
        ` : ""}
        ${statusClass === "free" ? `
          <input type="text" placeholder="Your Name" id="name-${slotId}">
          <input type="text" placeholder="Location" id="location-${slotId}">
          <input type="datetime-local" id="arrival-${slotId}">
          <input type="datetime-local" id="leaving-${slotId}">
          <button onclick="bookSlot('${slotId}')">Book Slot</button>
        ` : ""}
      `;
      slotGrid.appendChild(card);
    });
  });

  // Book slot function
  function bookSlot(slotId) {
    const name = document.getElementById(`name-${slotId}`).value;
    const location = document.getElementById(`location-${slotId}`).value;
    const arrival = document.getElementById(`arrival-${slotId}`).value;
    const leaving = document.getElementById(`leaving-${slotId}`).value;
    if (!name || !location || !arrival || !leaving) {
      alert("Please fill in all fields");
      return;
    }
    db.ref("slots/" + slotId + "/booking").set({
      name,
      location,
      arrival,
      leaving
    });
  }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Parking Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
  }

  h1 { text-align: center; margin-bottom: 20px; }

  .container {
    display: flex;
    gap: 40px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .parking-map, .booking-panel {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
  }

  .parking-map {
    min-width: 300px;
  }

  .slot {
    width: 80px;
    height: 120px;
    margin: 10px;
    display: inline-block;
    border-radius: 8px;
    color: #fff;
    font-weight: bold;
    line-height: 120px;
    text-align: center;
    font-size: 14px;
  }

  .free { background: green; }
  .booked { background: orange; }
  .occupied { background: red; }
  .non-booking { background: #888; }

  .booking-panel {
    min-width: 250px;
  }

  .booking-panel label {
    display: block;
    margin-top: 10px;
  }

  .booking-panel input {
    width: 90%;
    padding: 5px;
    margin-top: 5px;
  }

  .booking-panel button {
    margin-top: 15px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: #0077cc;
    color: #fff;
    cursor: pointer;
  }
  .booking-panel button:hover { background: #005fa3; }

  #countdown { margin-top: 10px; font-size: 14px; color: #333; }
</style>
</head>
<body>

<h1>Smart Parking System</h1>
<div class="container">
  <!-- Parking Map -->
  <div class="parking-map">
    <h3>Parking Layout</h3>
    <div class="slot free" id="slot1">Slot 1</div>
    <div class="slot non-booking">Non-Booking Area</div>
  </div>

  <!-- Booking Panel -->
  <div class="booking-panel">
    <h3>Book Your Slot</h3>
    <form id="bookingForm">
      <label>Name:</label>
      <input type="text" id="name" required>
      <label>Arrival Time (HH:MM):</label>
      <input type="time" id="arrival" required>
      <label>Leave Time (HH:MM):</label>
      <input type="time" id="leave" required>
      <button type="submit">Book Slot</button>
    </form>
    <button id="cancelBtn" style="background:red;">Cancel Booking</button>
    <div id="countdown"></div>
  </div>
</div>

<script>
const firebaseURL = "https://smartparkingsystem-55a05-default-rtdb.firebaseio.com/S1.json";

// Convert HH:MM to minutes
function toMinutes(hhmm){
  if(!hhmm || hhmm.length < 5) return null;
  const h = parseInt(hhmm.substring(0,2));
  const m = parseInt(hhmm.substring(3,5));
  return h*60 + m;
}

// Write state to Firebase
async function writeState(state, data={}){
  const payload = {
    state: state,
    name: data.name || "",
    arrivalTime: data.arrivalTime || "",
    leaveTime: data.leaveTime || ""
  };
  await fetch(firebaseURL, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
}

// Load status and update UI
async function loadStatus(){
  const res = await fetch(firebaseURL);
  const data = await res.json();
  const slotEl = document.getElementById("slot1");
  const countdownEl = document.getElementById("countdown");
  countdownEl.textContent = "";

  if(!data) return;

  let state = data.state;
  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();
  const arrMin = toMinutes(data.arrivalTime);
  const leaveMin = toMinutes(data.leaveTime);

  // Booking logic
  if(state === "booked" && arrMin){
    if(nowMin >= arrMin && nowMin < leaveMin){
      state = "occupied";
    } else if(nowMin > arrMin + 1){ // expired
      state = "free";
      await writeState("free");
    }
  }
  if(state === "occupied" && leaveMin && nowMin >= leaveMin){
    state = "free";
    await writeState("free");
  }

  // Update slot display
  slotEl.className = "slot " + state;
  slotEl.textContent = state.toUpperCase();

  // Countdown
  if(state === "booked" && arrMin){
    const minsLeft = arrMin - nowMin;
    countdownEl.textContent = "Reserved period starts in " + minsLeft + " min";
  } else if(state === "occupied" && leaveMin){
    const minsLeft = leaveMin - nowMin;
    countdownEl.textContent = "Time left: " + minsLeft + " min";
  }
}

// Booking form
document.getElementById("bookingForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const payload = {
    state: "booked",
    name: document.getElementById("name").value,
    arrivalTime: document.getElementById("arrival").value,
    leaveTime: document.getElementById("leave").value
  };
  await fetch(firebaseURL, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  loadStatus();
});

// Cancel booking
document.getElementById("cancelBtn").addEventListener("click", async ()=>{
  await writeState("free");
  loadStatus();
});

// Auto-refresh
setInterval(loadStatus, 2000);
loadStatus();
</script>

</body>
</html>

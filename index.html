<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Parking — S1 Dashboard</title>

<!-- ====== Minimal, modern styling ====== -->
<style>
  :root{
    --bg:#0f172a; --card:#0b1224; --muted:#9aa4b2;
    --free:#16a34a; --booked:#0ea5e9; --occ:#ef4444;
    --border:#1f2937; --ink:#e5e7eb;
    --btn:#1d4ed8; --btn-hover:#1e40af;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0b1022;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#0b1022cc;border-bottom:1px solid var(--border);backdrop-filter:blur(6px);padding:14px 16px}
  header h1{margin:0;font-size:18px}
  header .sub{font-size:12px;color:var(--muted)}
  .container{max-width:760px;margin:18px auto;padding:0 16px;display:grid;gap:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .card h2{margin:0 0 8px 0;font-size:16px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:#041;vertical-align:middle}
  .pill.free{background:#bbf7d0;color:#052e16;border:1px solid #86efac}
  .pill.occupied{background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca}
  .pill.booked{background:#dbeafe;color:#0c4a6e;border:1px solid #bfdbfe}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  label{display:block;font-size:12px;color:#cbd5e1;margin-top:8px}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0a1222;color:#e5e7eb}
  .btn{all:unset;display:inline-block;background:var(--btn);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn:hover{background:var(--btn-hover)}
  .btn.secondary{background:#1f2937}
  .grid2{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }
  .timer{font-variant-numeric:tabular-nums;font-weight:700}
  .mapwrap{border-radius:12px;overflow:hidden;border:1px solid #334155}
  a.link{color:#60a5fa;text-decoration:none}
</style>
</head>
<body>
<header>
  <h1>🚗 Smart Parking — Slot S1</h1>
  <div class="sub" id="toast">Ready.</div>
</header>

<div class="container">
  <!-- SECTION 1: CURRENT STATUS -->
  <section class="card" id="sec-status">
    <div class="row">
      <h2>Current Status</h2>
      <span id="statusPill" class="pill free">FREE</span>
    </div>
    <div class="muted">Live from sensor (ESP32). Independent of future bookings.</div>
    <div class="row" style="margin-top:10px">
      <div class="muted" id="lastUpdate">Last update: —</div>
      <button class="btn secondary" id="toggleBtn">Mark as Occupied</button>
    </div>
  </section>

  <!-- SECTION 2: UPCOMING BOOKING -->
  <section class="card" id="sec-booking">
    <h2>Upcoming Booking</h2>
    <div id="bookingBlock" class="muted">No booking scheduled.</div>
    <div id="countdownWrap" class="muted" style="margin-top:6px;display:none;">
      Starts in: <span id="countdown" class="timer">—</span>
    </div>
    <hr style="border:none;border-top:1px solid #334155;margin:12px 0">
    <div class="grid2">
      <div>
        <label>Driver Name</label>
        <input id="name" placeholder="e.g., John Doe">
      </div>
      <div>
        <label>Location</label>
        <input id="location" placeholder="Nairobi CBD, Kenyatta Avenue" value="Nairobi CBD, Kenyatta Avenue">
      </div>
      <div>
        <label>Arrival (local)</label>
        <input id="arrival" type="datetime-local">
      </div>
      <div>
        <label>Leaving (local)</label>
        <input id="leaving" type="datetime-local">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="bookBtn">Book Slot</button>
      <button class="btn secondary" id="cancelBtn">Cancel Booking</button>
    </div>
    <div class="muted" style="margin-top:8px">
      Note: Slot remains FREE/occupied normally until arrival time. At arrival, a 1-minute grace applies.
    </div>
  </section>

  <!-- SECTION 3: MAP & LOCATION -->
  <section class="card" id="sec-map">
    <h2>Map & Location</h2>
    <div class="muted" id="locText">Nairobi CBD, Kenyatta Avenue</div>
    <div class="mapwrap" style="margin-top:8px">
      <iframe id="mapFrame" width="100%" height="300" style="border:0" loading="lazy" allowfullscreen
        referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div style="margin-top:8px">
      <a id="mapsLink" class="link" href="#" target="_blank" rel="noopener">Open in Google Maps ↗</a>
    </div>
  </section>
</div>

<!-- ====== Firebase (Compat v9 for simplicity) ====== -->
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
<script>
/* Your Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyC83XNFywh1cxT-0ty6pM9d_mIevHUzI74",
  authDomain: "smartparkingsystem-55a05.firebaseapp.com",
  databaseURL: "https://smartparkingsystem-55a05-default-rtdb.firebaseio.com",
  projectId: "smartparkingsystem-55a05",
  storageBucket: "smartparkingsystem-55a05.firebasestorage.app",
  messagingSenderId: "200855735860",
  appId: "1:200855735860:web:369dd1116fc4ab21148461",
  measurementId: "G-XHXNGLQBFH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Elements */
const $ = (id) => document.getElementById(id);
const statusPill = $("statusPill");
const toggleBtn = $("toggleBtn");
const bookingBlock = $("bookingBlock");
const cancelBtn = $("cancelBtn");
const bookBtn = $("bookBtn");
const countdownWrap = $("countdownWrap");
const countdownEl = $("countdown");
const mapFrame = $("mapFrame");
const locText = $("locText");
const mapsLink = $("mapsLink");
const toast = (m)=>{ $("toast").textContent=m; setTimeout(()=>$("toast").textContent="Ready.",3000); };

/* Map setup — replace with your actual Google Maps Embed API key */
const MAPS_KEY = "YOUR_GOOGLE_MAPS_EMBED_API_KEY"; // ← REQUIRED (do not use Firebase key)

/* Live subscription */
let timerInt = null;
db.ref("slots/S1").on("value", (snap)=>{
  const slot = snap.val() || {};
  renderStatus(slot);
  renderBooking(slot);
  renderMap(slot);
});

/* -------- SECTION 1: CURRENT STATUS -------- */
function renderStatus(slot){
  const occ = !!slot.occupied;
  statusPill.className = "pill " + (occ ? "occupied" : "free");
  statusPill.textContent = occ ? "OCCUPIED" : "FREE";
  toggleBtn.textContent = occ ? "Mark as Free" : "Mark as Occupied";
  $("lastUpdate").textContent = "Last update: " + new Date().toLocaleTimeString();
}

toggleBtn.onclick = ()=>{
  db.ref("slots/S1/occupied").transaction(v => !v);
  toast("Toggled occupied");
};

/* -------- SECTION 2: UPCOMING BOOKING -------- */
function renderBooking(slot){
  clearInterval(timerInt);
  const nowSec = Math.floor(Date.now()/1000);
  const b = slot.booking || null;

  if (!b){
    bookingBlock.innerHTML = "No booking scheduled.";
    countdownWrap.style.display = "none";
    return;
  }

  // prefer UNIX seconds if present, else parse string
  const arrTs = b.arrivalTs ? Number(b.arrivalTs) : Math.floor(Date.parse(b.arrival||0)/1000);
  const levTs = b.leavingTs ? Number(b.leavingTs) : Math.floor(Date.parse(b.leaving||0)/1000);
  const arrivalStr = arrTs ? new Date(arrTs*1000).toLocaleString() : (b.arrival || "—");
  const leavingStr = levTs ? new Date(levTs*1000).toLocaleString() : (b.leaving || "—");

  bookingBlock.innerHTML = `
    <div><b>Driver:</b> ${b.name||"—"}</div>
    <div><b>Arrival:</b> ${arrivalStr}</div>
    <div><b>Leaving:</b> ${leavingStr}</div>
    <div><b>Location:</b> ${b.location||"Nairobi CBD, Kenyatta Avenue"}</div>
    <div style="margin-top:6px">
      <span class="pill booked">BOOKING</span>
      <span class="muted">Slot remains free/occupied normally until arrival.</span>
    </div>
  `;

  // countdown to arrival if in future
  if (arrTs && arrTs > nowSec){
    countdownWrap.style.display = "block";
    let remaining = (arrTs - nowSec);
    updateCountdown(remaining);
    timerInt = setInterval(()=>{
      remaining -= 1;
      updateCountdown(remaining);
      if (remaining <= 0){ clearInterval(timerInt); countdownWrap.style.display = "none"; }
    }, 1000);
  } else {
    countdownWrap.style.display = "none";
  }
}

/* booking actions */
bookBtn.onclick = ()=>{
  const name = $("name").value.trim();
  const arrival = $("arrival").value;
  const leaving = $("leaving").value;
  const location = $("location").value.trim() || "Nairobi CBD, Kenyatta Avenue";
  if (!name || !arrival || !leaving){ toast("Please fill all fields."); return; }
  const arrivalTs = Math.floor(Date.parse(arrival)/1000);
  const leavingTs = Math.floor(Date.parse(leaving)/1000);
  db.ref("slots/S1").transaction(cur=>{
    cur = cur || {};
    if (cur.booking){ return; } // prevent overwrite
    return { ...cur, booking:{ name, arrival, leaving, location, arrivalTs, leavingTs } };
  }).then(()=> toast("Booking saved."));
};

cancelBtn.onclick = ()=>{
  db.ref("slots/S1/booking").remove().then(()=> toast("Booking canceled."));
};

/* countdown helper */
function updateCountdown(s){
  const d = Math.max(0, s);
  const h = Math.floor(d/3600);
  const m = Math.floor((d%3600)/60);
  const sec = d%60;
  countdownEl.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
}

/* -------- SECTION 3: MAP & LOCATION -------- */
function renderMap(slot){
  const loc = (slot.booking && slot.booking.location) ? slot.booking.location : "Nairobi CBD, Kenyatta Avenue";
  locText.textContent = loc;
  mapsLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
  // Embed map only if you put a valid Maps Embed API key
  if (MAPS_KEY && MAPS_KEY !== "YOUR_GOOGLE_MAPS_EMBED_API_KEY"){
    mapFrame.src = `https://www.google.com/maps/embed/v1/place?key=${MAPS_KEY}&q=${encodeURIComponent(loc)}`;
  } else {
    mapFrame.removeAttribute("src");
    mapFrame.outerHTML = `<div style="padding:12px" class="muted">
      Map not shown. Add your Google Maps Embed API key in <code>MAPS_KEY</code> to enable the embedded map.
      You can still use <a class="link" href="${mapsLink.href}" target="_blank" rel="noopener">Open in Google Maps ↗</a>.
    </div>`;
  }
}
</script>
</body>
</html>
